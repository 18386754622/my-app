!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).alova={})}(this,(function(e){"use strict";const t=Promise,o=e=>t.resolve(e),n=Object,r=void 0,s=null,a=!0,c=!1,i=(e,t,o)=>e.then(t,o),d=(e,t)=>e.catch(t),l=e=>e?e.getTime():Date.now(),u=e=>e.context,f=e=>e.config,h=e=>e.options,p=e=>h(u(e)),m=e=>h(e).statesHook,g=e=>JSON.stringify(e),y=e=>n.keys(e),v=(e,t)=>e.forEach(t),b=(e,...t)=>e.push(...t),S=e=>e.length,w=e=>Array.isArray(e),_=(e,t)=>delete e[t],E="memory",C="placeholder",R="restore",D=()=>{},A=e=>e,T=e=>"function"==typeof e,k=e=>"number"==typeof e&&!isNaN(e),P=e=>"string"==typeof e,$=e=>n.prototype.toString.call(e),x=e=>"[object Object]"===$(e),U=(e,t)=>e instanceof t,O=e=>{const{type:t,url:o,data:n}=e,{params:r,headers:s}=f(e);return g([t,o,r,n,s])},j=(e,t)=>{let o=s;return function(...n){const r=e.bind(this,...n);o&&(e=>{clearTimeout(e)})(o);const s=k(t)?t:t(...n);s>0?o=((e,t=0)=>setTimeout(e,t))(r,s):r()}},q=e=>{const t=f(e).localCache,o=e=>k(e)?l()+e:l(e);let n=E,s=0,a=c,i=r;if(!T(t))if(k(t)||U(t,Date))s=o(t);else{const{mode:e=E,expire:c=0,tag:d}=t||{};n=e,s=o(c),a=[C,R].includes(e),i=d?d.toString():r}return{e:s,m:n,s:a,t:i}},H=(e,t=[])=>T(e)?e(...t):e,N=e=>U(e,t)?e:o(e),L=(e,...t)=>new e(...t),M={},I=(e,t=a)=>{let o,n="",s=r;if(P(e)||U(e,RegExp))s=e;else if(x(e)){s=e.name,o=e.filter;const t=e.alova;n=t?t.id:n}const c=[];return v(y(M),(e=>{if(!n||e===n){const t=M[e];v(y(t),(e=>{const o=t[e],n=f(o).name||"";(s===r||(U(s,RegExp)?s.test(n):n===s))&&(o.__key__=e,b(c,o))}))}})),o?c[t?"filter":"find"](o):t?c:c[0]},G=(e,t)=>{let o;return o=w(e)?e:e&&P(e.url)?t?[e]:e:I(e,t),o};let B={};const F=(e,t)=>{const o=B[e];if(o){const e=o[t];if(e){if(!(e[1]<l()))return e[0];_(o,t)}}},J=(e,t,o,n=0)=>{if(n>l()&&o){(B[e]=B[e]||{})[t]=[o,n]}},W=(e,t)=>"alova."+e+t,K=(e,t,o,n,r,a=s)=>{n>0&&o&&r.set(W(e,t),[o,n===1/0?s:n,a])},z=(e,t,o,n=null)=>{const r=o.get(W(e,t));if(r){const[a,c,i=s]=r;if(i===n&&(!c||c>l()))return a;Q(e,t,o)}},Q=(e,t,o)=>{o.remove(W(e,t))};const V=e=>{if(!e)return void(B={});const t=G(e,a);v(t,(e=>{const{id:t,storage:o}=u(e),n=e.__key__||O(e);((e,t)=>{const o=B[e];o&&_(o,t)})(t,n),Q(t,n,o)}))},X={},Y=(e,t,o)=>{const n=y(o).filter((e=>o[e]!==r)).map((e=>`${e}=${o[e]}`)).join("&");let s=n?t.includes("?")?`${t}&${n}`:`${t}?${n}`:t;return s=s.match(/^(\/|https?:\/\/)/)?s:`/${s}`,(e.endsWith("/")?e.slice(0,-1):e)+s};function Z(e,o){let n=r,s=a;return{abort:()=>n&&n.abort(),onDownload:e=>n&&n.onDownload&&n.onDownload(e),onUpload:e=>n&&n.onUpload&&n.onUpload(e),response:()=>{const{beforeRequest:i=D,responsed:d,responded:l,requestAdapter:h}=p(e),m=O(e),g=(e=>{const{data:t,config:o}=e,n={...o},{headers:r={},params:s={}}=n;return n.headers={...r},n.params={...s},L(ee,e.type,u(e),e.url,n,t)})(e);return N(i(g)).then((()=>{const{baseURL:i,url:p,type:y,data:v}=g,{id:b,storage:w}=u(g),{params:E={},headers:C={},localCache:R,transformData:D=A,name:k="",shareRequest:P}=f(g);if(T(R))return R();if(!o){const e=F(b,m);if(e)return e}s=c;const{e:O,s:j,t:H}=q(g),L=X[b]=X[b]||{};if(n=L[m],!P||!n){const e=h({url:Y(i,p,E),type:y,data:v,headers:C},g);n=L[m]=e}let G=A,B=r;const W=l||d;if(T(W))G=W;else if(x(W)){const{onSuccess:e,onError:t}=W;G=T(e)?e:G,B=T(t)?t:B}return t.all([n.response(),n.headers()]).then((([t,o])=>N(G(t,g)).then((e=>D(e,o))).then((t=>{((e,t,o)=>{(M[e]=M[e]||{})[t]=o})(b,m,e);const o=g.data,n=!o||!(e=>{const t=$(e);return/^\[object (Blob|FormData|ReadableStream|URLSearchParams)\]$/i.test(t)||U(e,ArrayBuffer)})(o);n&&(J(b,m,t,O),j&&K(b,m,t,O,w,H));const r=I({filter:e=>{let t=c;const o=e.hitSource;if(o)for(const e in o){const n=o[e];if(U(n,RegExp)?n.test(k):n===k||n===m){t=a;break}}return t}});return S(r)>0&&V(r),t}))),(e=>{if(!T(B))throw e;return B(e,g)})).finally((()=>_(L,m)))}))},fromCache:()=>s}}class ee{constructor(e,t,o,n,s){const a=h(t);this.baseURL=a.baseURL||"",this.url=o,this.type=e,this.context=t;const c={};v(["timeout","shareRequest"],(e=>{a[e]!==r&&(c[e]=a[e])}));const i="localCache",d=x(a[i])?a[i][e]:r;d!==r&&(c[i]=d);const l=null==n?void 0:n.hitSource;l&&(this.hitSource=(w(l)?l:[l]).map((e=>U(e,ee)?O(e):e)),_(n,"hitSource")),this.config={...c,headers:{},params:{},...n||{}},this.data=s}send(e=c){return Z(this,e).response()}setName(e){f(this).name=e}}var te=()=>{const e=window.localStorage;return{set:(t,o)=>e.setItem(t,g(o)),get:t=>{const o=e.getItem(t);return o?(n=o,JSON.parse(n)):o;var n},remove:t=>e.removeItem(t)}};const oe=[],ne={localCache:{GET:3e5},shareRequest:a};let re=0;class se{constructor(e){this.id=++re+"",this.storage=e.storageAdapter||te(),this.options={...ne,...e}}Get(e,t){return L(ee,"GET",this,e,t)}Post(e,t={},o){return L(ee,"POST",this,e,o,t)}Delete(e,t={},o){return L(ee,"DELETE",this,e,o,t)}Put(e,t={},o){return L(ee,"PUT",this,e,o,t)}Head(e,t){return L(ee,"HEAD",this,e,t)}Patch(e,t={},o){return L(ee,"PATCH",this,e,o,t)}Options(e,t){return L(ee,"OPTIONS",this,e,t)}}var ae=(e,t)=>{const o=L(Error,`[alova]${e}`);return t&&(o.name=t),o};function ce(e,t){if(!e)throw ae(t)}function ie(){ce(S(oe)>0,"please create a alova instance first.")}const de={},le=(e,t)=>{const o=de[e];return o?o[t]:r};var ue=(e,t)=>t(),fe=(e,t,o,s,a,c,i)=>{const d={method:t,sendArgs:o,data:a,error:c,status:i,fromCache:s},l={};v(y(d),(e=>{d[e]!==r&&(l[e]=d[e])}));const u=["AlovaSuccessEvent","AlovaErrorEvent","AlovaCompleteEvent"][e];return u&&n.defineProperty(l,Symbol.toStringTag,{value:u}),l};function he(e,n,s,l,h,p,m=[],g=c){const{force:b=c,middleware:w=ue}=s,{id:C,options:A,storage:k}=u(e),{update:P}=A.statesHook,$=O(e);let x=D,j=D;const{e:H,m:N,t:L}=q(e);let M=F(C,$);if(!g){const e=N!==E?z(C,$,k,L):r;N===R&&!M&&e&&(J(C,$,e,H),M=e),(M||e)&&P({data:M||e},n),j=e=>((e,t,o)=>{(de[e]=de[e]||{})[t]=o})(C,$,e),j(n),x=()=>((e,t)=>{const o=de[e];o&&_(o,t)})(C,$)}let I={},G=o(r),B=()=>!!M;let W,K,Q;const V=w({method:e,cachedResponse:M,sendArgs:m,config:s,frontStates:n,update:e=>P(e,n),decorateSuccess:e=>{T(e)&&(W=e)},decorateError:e=>{T(e)&&(K=e)},decorateComplete:e=>{T(e)&&(Q=e)}},(t=>{const{force:o=b,method:r=e}=t||{},s=((e,t=[])=>T(e)?e(...t):e)(o,m),{response:c,onDownload:i=D,onUpload:d=D,fromCache:l}=I=Z(r,s);B=l,!s&&M||P({loading:a},n),G=c();const u=e=>(t,o)=>{P({[e]:{loaded:t,total:o}},n)},{enableDownload:h,enableUpload:p}=f(e);return h&&i(u("downloading")),p&&d(u("uploading")),G}));ce(U(V,t),"middleware must be a async function");const X=(e,t,o)=>{v(e,((n,r)=>T(t)?t(n,o,r,S(e)):n(o)))},Y=d(i(V,(t=>{const o=t=>{if(g){const e=le(C,$);e&&P({data:t},e)}else P({data:t},n);return P({loading:c},n),X(l,W,fe(0,e,m,B(),t)),X(p,Q,fe(2,e,m,B(),t,r,"success")),t};return t!==r?o(t):S(y(I))>0?i(G,o,(()=>o(r))):void 0})),(o=>{return P({error:o,loading:c},n),X(h,K,fe(1,e,m,B(),r,o)),X(p,Q,fe(2,e,m,B(),r,o,"error")),s=o,t.reject(s);var s}));return{...I,p:Y,r:x,s:j}}function pe(e,t,o,n,s=c,i,l=0){const{create:u,export:f,effectRequest:h,update:p}=m(e),g={total:0,loaded:0},{managedStates:y={}}=o,v={...y,data:u(n),loading:u(c),error:u(r),downloading:u({...g}),uploading:u({...g})},S=[],_=[],E=[];let C=r,R=D,A=D;const T=(e=H(t),n=o,r,s)=>{const{abort:a,p:c,r:i,s:d}=he(e,v,n,S,_,E,r,s);return C=a,R=i,A=d,c},P=()=>{d(T(),D)};h({handler:i!==r?j(P,(e=>k(e)?w(l)?l[e]:l:0)):P,removeStates:()=>R(),saveStates:e=>A(e),frontStates:v,watchingStates:i,immediate:null!=s?s:a});return{...{loading:f(v.loading),data:f(v.data),error:f(v.error),downloading:f(v.downloading),uploading:f(v.uploading)},onSuccess(e){b(S,e)},onError(e){b(_,e)},onComplete(e){b(E,e)},update(e){p(e,v)},abort:()=>(C||D)(),send:(e,n,r)=>T(n||H(t,e),o,e,r)}}e.Method=ee,e.createAlova=e=>{const t=L(se,e);return oe[0]&&ce(m(oe[0])===m(t),"must use the same statesHook in one environment"),b(oe,t),t},e.getMethodKey=O,e.invalidateCache=V,e.matchSnapshotMethod=I,e.queryCache=e=>{const t=G(e,c);if(t){const{id:e,storage:o}=u(t),n=t.__key__||O(t);return F(e,n)||z(e,n,o,q(t).t)}},e.setCache=(e,t)=>{const o=G(e,a);v(o,(e=>{const{id:o,storage:n}=u(e),s=e.__key__||O(e),{e:a,s:c,t:i}=q(e);let d=t;if(T(t)){const e=F(o,s)||z(o,s,n,i);if(d=t(e),d===r)return}J(o,s,d,a),c&&K(o,s,d,a,n,i)}))},e.updateState=function(e,t,o={}){const{onMatch:n=D}=o,s=G(e,c);let i=c;if(s){n(s);const{statesHook:{dehydrate:e,update:o}}=p(s),c=s.__key__||O(s),{id:d,storage:l}=u(s),f=le(d,c);if(f){const{e:n,s:u,t:h}=q(s),p=T(t)?{data:t}:t;v(y(p),(t=>{ce(f[t]!==r,`can not find state named \`${t}\``),ce(!y(f).slice(-4).includes(t),"can not update preset states");try{const r=p[t](e(f[t]));o({[t]:r},f),J(d,c,r,n),u&&K(d,c,r,n,l,h)}catch(e){throw ae(`managed state \`${t}\` must be a state.`)}})),i=a}}return i},e.useFetcher=function(e={}){ie();const t=pe(oe[0],D,e);return{fetching:t.loading,error:t.error,downloading:t.downloading,uploading:t.uploading,onSuccess:t.onSuccess,onError:t.onError,onComplete:t.onComplete,abort:t.abort,fetch:(e,...o)=>{const n=G(e,c);ce(!!n,"method instance is not found"),t.send(o,n,a)}}},e.useRequest=function(e,t={}){ie();const{immediate:o=a,initialData:n}=t,r=pe(oe[0],e,t,n,!!o);return{...r,send:(...e)=>r.send(e)}},e.useWatcher=function(e,t,o={}){ce(t&&S(t)>0,"must specify at least one watching state"),ie();const{immediate:n,debounce:r=0,initialData:s}=o,a=pe(oe[0],e,o,s,!!n,t,r);return{...a,send:(...e)=>a.send(e)}},Object.defineProperty(e,"__esModule",{value:!0})}));
